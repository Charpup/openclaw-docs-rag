# 技术可行性审计报告：OpenClaw + MemU 双记忆系统

**审计日期**: 2026-02-10  
**审计对象**: OpenClaw memorySearch + MemU 自托管系统  
**审计者**: Galatea  
**状态**: 待二次审计 (Claude)

---

## 1. 执行摘要

### 现状诊断

```
┌─────────────────────────────────────────────────────────────────┐
│                      记忆系统架构现状                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐      ┌─────────────────────────────┐  │
│  │   OpenClaw 内置      │      │      MemU 自托管             │  │
│  │   memory_search     │      │    (Docker + PostgreSQL)     │  │
│  │                     │      │                             │  │
│  │  ✅ 正在运行         │      │  ✅ 容器运行中               │  │
│  │  ✅ 使用外部 API     │      │  ✅ 数据库可连接             │  │
│  │  ✅ 搜索 MEMORY.md  │      │  ❌ 记忆表为空 (0 rows)      │  │
│  │                     │      │  ❌ 无数据写入记录           │  │
│  │  配置: apiyi API    │      │  配置: localhost:5432       │  │
│  └─────────────────────┘      └─────────────────────────────┘  │
│           │                              │                      │
│           │      ❌ 无集成               │                      │
│           └──────────────┬───────────────┘                      │
│                          ▼                                     │
│              ┌─────────────────────┐                           │
│              │   问题: 两个系统     │                           │
│              │   完全独立运作       │                           │
│              │   没有数据互通       │                           │
│              └─────────────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 关键发现

| 发现 | 严重性 | 说明 |
|------|--------|------|
| MemU 数据库为空 | 🔴 高 | 自托管 MemU 从未写入数据 |
| 系统未集成 | 🔴 高 | OpenClaw 和 MemU 无连接 |
| 双重配置 | 🟡 中 | 维护两套系统增加复杂度 |
| docs-rag 依赖 | 🟡 中 | 需要 PostgreSQL + pgvector |

---

## 2. 技术架构分析

### 2.1 OpenClaw memory_search 系统

**工作原理**:
```
用户查询
    ↓
Embedding (OpenAI API / Local sqlite-vec)
    ↓
向量搜索 + BM25 混合 (70% / 30%)
    ↓
搜索 MEMORY.md + memory/**/*.md
    ↓
返回相关片段
```

**当前配置**:
```json
{
  "memorySearch": {
    "enabled": true,
    "provider": "openai",
    "model": "text-embedding-3-small",
    "remote": {
      "baseUrl": "https://api.apiyi.com/v1",
      "apiKey": "sk-..."
    }
  }
}
```

**特点**:
- ✅ 文件级记忆（Markdown 格式）
- ✅ 混合搜索（语义 + 关键词）
- ✅ 自动分块 (~400 tokens)
- ✅ 无需本地数据库（使用 API）
- ❌ 仅搜索文件，不主动存储

### 2.2 MemU 自托管系统

**工作原理**:
```
对话/交互
    ↓
MemU Client (memu-py)
    ↓
PostgreSQL + pgvector (本地)
    ↓
存储结构化记忆
    ↓
检索时语义搜索 + 主动预测
```

**当前状态**:
```
Docker 容器: memu-postgres (pgvector:pg17)
  ↳ 状态: Up 27 hours
  ↳ 端口: 5432:5432
  ↳ 内存: ~58MB
  ↳ 数据库: memu_db
  ↳ 表: 6 张表已创建
  ↳ memory_items: 0 rows ← 问题！
```

**特点**:
- ✅ 结构化记忆存储
- ✅ 主动意图预测
- ✅ 跨会话连续性
- ❌ 需要客户端集成
- ❌ 当前无数据写入

### 2.3 双系统可行性分析

**方案 A: 双系统并行**

```
┌─────────────────────────────────────────────────────────┐
│  双记忆系统架构                                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   用户输入                                               │
│      ↓                                                  │
│   ┌──────────────┐   ┌──────────────┐                  │
│   │ OpenClaw     │   │ MemU         │                  │
│   │ memory_search│   │ memorize()   │                  │
│   │ ───────────  │   │ ───────────  │                  │
│   │ • 文件搜索   │   │ • 结构化存储 │                  │
│   │ • 语义匹配   │   │ • 意图预测   │                  │
│   │ • 即时检索   │   │ • 长期学习   │                  │
│   └──────────────┘   └──────────────┘                  │
│          ↓                  ↓                          │
│   ┌────────────────────────────────┐                   │
│   │         LLM 上下文              │                   │
│   │   (融合两种记忆源)              │                   │
│   └────────────────────────────────┘                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**可行性**: ⚠️ **技术可行，但复杂度高**

**优点**:
- 文件记忆 (OpenClaw) + 结构化记忆 (MemU) 互补
- MemU 的主动预测可增强 OpenClaw 的被动搜索
- 双重保障，单点故障不影响全部

**缺点**:
- 需要维护两套系统
- 记忆源冲突时难以调和
- 数据冗余（同一条记忆存两份）
- 需要自定义代码桥接

**方案 B: MemU 作为 OpenClaw 的存储后端**

**可行性**: ❌ **不可行** (API 不兼容)

OpenClaw 的 memory_search 目前只支持:
- 本地文件 (MEMORY.md)
- OpenAI/Gemini embedding API

MemU 使用自己的 API 和存储格式，无法直接作为 OpenClaw 的后端。

**方案 C: 只用 OpenClaw (放弃 MemU)**

**可行性**: ✅ **可行，但功能减少**

- 保留现有 memory_search 配置
- 将 MemU 容器改为 docs-rag 使用
- 损失 MemU 的主动预测功能

**方案 D: 只用 MemU (改造 OpenClaw)**

**可行性**: ⚠️ **需要大量定制开发**

- 需要修改 OpenClaw 源码或创建自定义工具
- 将 MemU 查询结果注入 OpenClaw 上下文
- 工作量较大

---

## 3. 部署选项评估

### 3.1 Docker vs 本地 PostgreSQL

| 维度 | Docker | 本地安装 |
|------|--------|----------|
| **隔离性** | ✅ 高 | ⚠️ 低 |
| **可移植性** | ✅ 高 | ❌ 低 |
| **资源占用** | ~58MB RAM | ~50MB RAM |
| **备份/恢复** | ✅ 卷快照 | ⚠️ 手动 |
| **版本管理** | ✅ 镜像标签 | ❌ 包管理器 |
| **运维复杂度** | ✅ 低 | ⚠️ 中 |
| **数据持久化** | ✅ Docker volume | ✅ 本地目录 |

**推荐**: **Docker** ✅

理由：
1. 已在运行，迁移成本
2. pgvector 扩展安装复杂，Docker 镜像已包含
3. 备份通过卷管理更方便
4. 资源占用合理 (58MB)

### 3.2 复用现有 MemU 容器 vs 新建容器

**当前 MemU 容器配置**:
```
镜像: pgvector/pgvector:pg17
端口: 5432:5432
卷: memu_data:/var/lib/postgresql/data
数据库: memu_db
用户: memu / memu_secure_password
表: memory_items, memory_categories, category_items, resources, alembic_version
```

**方案 A: 复用现有容器**

为 docs-rag 创建新表:
```sql
CREATE TABLE openclaw_docs_chunks (...);
```

**优点**:
- 节省资源（只运行一个 PostgreSQL）
- 统一管理

**缺点**:
- 表结构混杂（MemU + docs-rag）
- 备份/恢复时需要筛选
- 权限管理复杂

**方案 B: 新建专用容器**

```bash
docker run -d \
  --name docs-rag-postgres \
  -e POSTGRES_USER=docsrag \
  -e POSTGRES_PASSWORD=... \
  -e POSTGRES_DB=docsrag_db \
  -p 5433:5432 \
  -v docsrag_data:/var/lib/postgresql/data \
  pgvector/pgvector:pg17
```

**优点**:
- 完全隔离
- 独立备份/恢复
- 清晰权限边界

**缺点**:
- 额外 50-60MB 内存
- 多一个容器维护

**推荐**: **方案 A - 复用现有容器** ✅

理由：
1. 当前系统资源充足（7.5GB RAM，使用 2GB）
2. 但表隔离可以通过 schema 或前缀实现
3. 简化运维

---

## 4. 资源占用评估

### 当前系统资源

```
内存: 7.5 GB total
  ├─ 已用: 2.0 GB
  ├─ 可用: 5.5 GB
  └─ MemU: 58 MB (0.75%)

磁盘: 120 GB total
  ├─ 已用: 52 GB (44%)
  ├─ 可用: 69 GB
  └─ Docker: /var/lib/docker 在根分区

CPU: 空闲状态 0% (MemU)
```

### 增加 docs-rag 后的预估

| 组件 | 内存 | 磁盘 | CPU |
|------|------|------|-----|
| 现有 MemU | 58 MB | ~100 MB | 0% |
| docs-rag 数据 | +0 MB (复用) | +~50 MB (向量) | +0% |
| 同步时峰值 | +100 MB (Node.js) | - | +5% |
| **总计** | **<200 MB** | **<200 MB** | **<5%** |

**结论**: 资源充足，无需担心 ✅

---

## 5. 实施建议

### 推荐方案: **整合 MemU 至 docs-rag，OpenClaw 保持现状**

```
┌─────────────────────────────────────────────────────────┐
│                 推荐架构                                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   ┌─────────────────────┐                               │
│   │   OpenClaw          │  ← 保持现有配置               │
│   │   memory_search     │     (apiyi API)               │
│   │                     │                               │
│   │   搜索 MEMORY.md    │                               │
│   └─────────────────────┘                               │
│            ↑                                            │
│            │ 文件级记忆                                  │
│            │                                            │
│   ┌─────────────────────┐                               │
│   │   MemU 数据库       │  ← 转为 docs-rag 专用          │
│   │   (PostgreSQL)      │     放弃 MemU 客户端           │
│   │                     │                               │
│   │   • openclaw_docs   │     表                        │
│   │   • memory_items    │     保留但不再写入             │
│   └─────────────────────┘                               │
│            ↑                                            │
│            │ 文档向量                                    │
│            │                                            │
│   ┌─────────────────────┐                               │
│   │   docs-rag skill    │                               │
│   │   (Node.js)         │                               │
│   └─────────────────────┘                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 实施步骤

**Phase 1: 环境配置 (15 min)**
1. 安装 PostgreSQL 客户端
2. 设置环境变量 (MEMU_DB_PASSWORD, OPENAI_API_KEY)
3. 验证数据库连接

**Phase 2: docs-rag 初始化 (30 min)**
1. 在现有 MemU 数据库创建 docs-rag 表
2. 同步 OpenClaw 文档
3. 测试查询功能

**Phase 3: 验证与清理 (15 min)**
1. 确认 docs-rag 工作正常
2. 标记 MemU 客户端不再使用
3. 更新文档

**总时间**: ~60 分钟

---

## 6. 风险与缓解

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| PostgreSQL 容器重启 | 中 | 服务中断 | 使用持久化卷 (已配置) |
| 数据丢失 | 低 | 高 | 定期备份脚本 |
| API 限额耗尽 | 中 | 中 | 监控使用情况 |
| 内存泄漏 | 低 | 低 | 监控容器资源 |

---

## 7. 审计结论

### 对问题的回答

**Q1: OpenClaw + MemU 双记忆系统是否可行？**

A: ⚠️ **技术上可行，但不推荐**

- 可行: 两个系统可以并行运行
- 不推荐: 维护复杂度高，记忆源可能冲突，无现成集成方案
- 建议: 选择其一，或明确分工（OpenClaw 文件记忆，MemU 结构化记忆）

**Q2: PostgreSQL 是否应继续 Docker 运行？**

A: ✅ **是，继续 Docker**

- 已在运行，迁移无收益
- pgvector 安装复杂，Docker 简化运维
- 资源占用合理

**Q3: docs-rag 能否复用现有 MemU 容器？**

A: ✅ **是，推荐复用**

- 表隔离可通过 schema 实现
- 节省资源
- 统一备份管理

**Q4: 资源占用评估**

A: ✅ **资源充足**

- 当前 MemU: 58MB RAM
- 增加 docs-rag: 预估 +50MB 数据
- 系统总内存: 7.5GB，充足

### 最终建议

1. **接受现状**: OpenClaw 使用外部 API 进行记忆搜索是正常设计，不是配置错误
2. **转化 MemU**: 将自托管 MemU 转为 docs-rag 的基础设施
3. **放弃 MemU 客户端**: 不追求双记忆系统，降低复杂度
4. **保留扩展性**: 如未来需要 MemU 功能，可重新启用

---

## 8. 待二次审计问题 (Claude)

1. 上述架构分析是否遗漏了关键依赖？
2. 放弃 MemU 主动预测功能的影响评估是否准确？
3. 是否有更好的方案整合 OpenClaw 和 MemU？
4. docs-rag 表结构设计是否合理？
5. 环境变量和配置的安全存储方案？

---

*报告完成时间: 2026-02-10 22:40 UTC*  
*等待 Claude 二次审计*
